{% extends "base.html" %}

{% block title %}Shida - Chat{% endblock %}

{% block content %}
<div class="chat-container">
    <div class="chat-header">
        <button class="back-btn" onclick="history.back()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
        <img src="https://via.placeholder.com/40" alt="" class="chat-avatar" id="chatAvatar">
        <div class="chat-user-info">
            <div class="chat-user-name" id="chatUserName">Conversation</div>
            <div class="chat-status" id="chatStatus">
                <span class="status-dot"></span>
                En ligne
            </div>
        </div>
        <button class="chat-options" onclick="showChatOptions()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="1"></circle>
                <circle cx="12" cy="5" r="1"></circle>
                <circle cx="12" cy="19" r="1"></circle>
            </svg>
        </button>
    </div>
    
    <div class="chat-messages" id="chatMessages">
        <div class="loading-spinner">
            <div class="spinner"></div>
        </div>
    </div>
    
    <div class="chat-input-container">
        <button class="attach-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"></path>
            </svg>
        </button>
        <input type="text" class="chat-input" id="messageInput" placeholder="Votre message...">
        <button class="send-btn" id="sendBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <line x1="22" y1="2" x2="11" y2="13"></line>
                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
        </button>
    </div>
</div>

<div class="options-overlay" id="optionsOverlay" onclick="hideChatOptions()">
    <div class="options-menu" onclick="event.stopPropagation()">
        <button class="option-item" onclick="reportUser()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"></path>
                <line x1="4" y1="22" x2="4" y2="15"></line>
            </svg>
            Signaler
        </button>
        <button class="option-item danger" onclick="blockUser()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="4.93" y1="4.93" x2="19.07" y2="19.07"></line>
            </svg>
            Bloquer
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const matchId = {{ match_id }};
let matchData = null;

document.addEventListener('DOMContentLoaded', async () => {
    await ShidaApp.init();
    await loadMatchInfo();
    Chat.init(matchId);
});

async function loadMatchInfo() {
    try {
        const response = await fetch('/api/matches');
        const matches = await response.json();
        matchData = matches.find(m => m.id === matchId);
        
        if (matchData && matchData.other_user) {
            document.getElementById('chatAvatar').src = matchData.other_user.photo_url || 'https://via.placeholder.com/40';
            document.getElementById('chatUserName').textContent = `${matchData.other_user.name}, ${matchData.other_user.age}`;
        }
    } catch (error) {
        console.error('Failed to load match info:', error);
    }
}

function showChatOptions() {
    document.getElementById('optionsOverlay').classList.add('active');
}

function hideChatOptions() {
    document.getElementById('optionsOverlay').classList.remove('active');
}

async function reportUser() {
    if (!matchData) return;
    
    const reason = prompt('Raison du signalement:');
    if (!reason) return;
    
    try {
        await fetch('/api/report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                user_id: matchData.other_user.user_id,
                report_type: 'inappropriate',
                reason: reason
            })
        });
        alert('Signalement envoye. Merci de nous aider a garder Shida sur.');
        hideChatOptions();
    } catch (error) {
        console.error('Failed to report:', error);
    }
}

function blockUser() {
    alert('Fonctionnalite bientot disponible');
    hideChatOptions();
}
</script>
{% endblock %}
