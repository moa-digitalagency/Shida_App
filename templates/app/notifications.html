{% extends "base.html" %}

{% block title %}Notifications - Shida{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-b from-gray-900 to-black text-white pb-20">
    <div class="p-4">
        <div class="flex items-center justify-between mb-6">
            <h1 class="text-2xl font-bold text-pink-500">NOTIFICATIONS</h1>
            <button onclick="markAllRead()" class="text-sm text-gray-400 hover:text-white">
                Tout marquer comme lu
            </button>
        </div>
        
        <div id="notifications-list" class="space-y-3">
        </div>
        
        <div id="empty-state" class="hidden text-center py-12">
            <i data-feather="bell-off" class="w-16 h-16 text-gray-600 mx-auto mb-4"></i>
            <p class="text-gray-500">Aucune notification</p>
        </div>
    </div>
</div>

{% include 'components/bottom_nav.html' %}

<script>
async function loadNotifications() {
    try {
        const res = await fetch('/api/notifications');
        const data = await res.json();
        
        const container = document.getElementById('notifications-list');
        const emptyState = document.getElementById('empty-state');
        
        if (!data.notifications || data.notifications.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        container.innerHTML = data.notifications.map(notif => `
            <div class="bg-gray-800 rounded-xl p-4 ${notif.is_read ? 'opacity-60' : ''}" onclick="markRead(${notif.id}, '${notif.action_url || ''}')">
                <div class="flex items-start">
                    <div class="w-10 h-10 rounded-full flex items-center justify-center mr-3 ${getNotifColor(notif.notification_type)}">
                        <i data-feather="${getNotifIcon(notif.notification_type)}" class="w-5 h-5 text-white"></i>
                    </div>
                    <div class="flex-1">
                        <div class="flex items-start justify-between">
                            <h3 class="font-bold text-white">${notif.title}</h3>
                            ${notif.is_read ? '' : '<span class="w-2 h-2 bg-pink-500 rounded-full"></span>'}
                        </div>
                        <p class="text-sm text-gray-400 mt-1">${notif.message}</p>
                        <p class="text-xs text-gray-500 mt-2">${formatDate(notif.created_at)}</p>
                    </div>
                </div>
            </div>
        `).join('');
        
        feather.replace();
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

function getNotifIcon(type) {
    const icons = {
        'welcome': 'gift',
        'match': 'heart',
        'message': 'message-circle',
        'like': 'heart',
        'view': 'eye',
        'tokens': 'circle',
        'vip': 'star',
        'verification': 'check-circle'
    };
    return icons[type] || 'bell';
}

function getNotifColor(type) {
    const colors = {
        'welcome': 'bg-green-500',
        'match': 'bg-pink-500',
        'message': 'bg-blue-500',
        'like': 'bg-red-500',
        'view': 'bg-purple-500',
        'tokens': 'bg-yellow-500',
        'vip': 'bg-yellow-500',
        'verification': 'bg-green-500'
    };
    return colors[type] || 'bg-gray-600';
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'Ã€ l\'instant';
    if (diff < 3600000) return `Il y a ${Math.floor(diff/60000)} min`;
    if (diff < 86400000) return `Il y a ${Math.floor(diff/3600000)}h`;
    return date.toLocaleDateString('fr-FR');
}

async function markRead(id, actionUrl) {
    try {
        await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
        if (actionUrl) {
            window.location.href = actionUrl;
        } else {
            loadNotifications();
        }
    } catch (error) {
        console.error('Error marking notification read:', error);
    }
}

async function markAllRead() {
    try {
        await fetch('/api/notifications/read-all', { method: 'POST' });
        loadNotifications();
    } catch (error) {
        console.error('Error marking all notifications read:', error);
    }
}

document.addEventListener('DOMContentLoaded', loadNotifications);
</script>
{% endblock %}
