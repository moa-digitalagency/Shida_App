{% extends "base.html" %}

{% block title %}Notifications - Shida{% endblock %}

{% block content %}
<div class="home-container">
    <div class="page-header">
        <h1 class="page-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="title-icon">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
            </svg>
            Notifications
        </h1>
        <button onclick="markAllRead()" class="page-subtitle" style="background: none; border: none; cursor: pointer;">
            Tout marquer comme lu
        </button>
    </div>
        
    <div id="notifications-list" class="conversation-list">
    </div>
    
    <div id="empty-state" class="hidden empty-state">
        <div class="empty-icon">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                <line x1="1" y1="1" x2="23" y2="23"></line>
            </svg>
        </div>
        <h3 class="empty-title">Aucune notification</h3>
        <p class="empty-subtitle">Vous n'avez pas encore de notifications</p>
    </div>
</div>

{% include 'components/bottom_nav.html' %}

<script>
async function loadNotifications() {
    try {
        const res = await fetch('/api/notifications');
        const data = await res.json();
        
        const container = document.getElementById('notifications-list');
        const emptyState = document.getElementById('empty-state');
        
        if (!data.notifications || data.notifications.length === 0) {
            container.innerHTML = '';
            emptyState.classList.remove('hidden');
            return;
        }
        
        emptyState.classList.add('hidden');
        
        container.innerHTML = data.notifications.map(notif => `
            <div class="conversation-item ${notif.is_read ? '' : 'unread'}" onclick="markRead(${notif.id}, '${notif.action_url || ''}')">
                <div class="avatar-wrapper">
                    <div class="notif-icon-wrapper ${getNotifColorClass(notif.notification_type)}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="notif-icon">
                            ${getNotifSvgPath(notif.notification_type)}
                        </svg>
                    </div>
                </div>
                <div class="conversation-info">
                    <div class="conversation-header">
                        <span class="conversation-name">${notif.title}</span>
                        <span class="conversation-time">${formatDate(notif.created_at)}</span>
                    </div>
                    <div class="conversation-preview">${notif.message}</div>
                </div>
                ${notif.is_read ? '' : '<span class="unread-badge"></span>'}
            </div>
        `).join('');
        
        feather.replace();
    } catch (error) {
        console.error('Error loading notifications:', error);
    }
}

function getNotifSvgPath(type) {
    const paths = {
        'welcome': '<path d="M20 12v6a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-6"></path><polyline points="12 15 12 3"></polyline><polyline points="17 8 12 3 7 8"></polyline>',
        'match': '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>',
        'message': '<path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>',
        'like': '<path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>',
        'view': '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle>',
        'tokens': '<circle cx="12" cy="12" r="10"></circle>',
        'vip': '<polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>',
        'verification': '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline>'
    };
    return paths[type] || '<path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path>';
}

function getNotifColorClass(type) {
    const colors = {
        'welcome': 'notif-green',
        'match': 'notif-pink',
        'message': 'notif-blue',
        'like': 'notif-pink',
        'view': 'notif-purple',
        'tokens': 'notif-gold',
        'vip': 'notif-gold',
        'verification': 'notif-green'
    };
    return colors[type] || 'notif-default';
}

function formatDate(dateStr) {
    const date = new Date(dateStr);
    const now = new Date();
    const diff = now - date;
    
    if (diff < 60000) return 'Ã€ l\'instant';
    if (diff < 3600000) return `Il y a ${Math.floor(diff/60000)} min`;
    if (diff < 86400000) return `Il y a ${Math.floor(diff/3600000)}h`;
    return date.toLocaleDateString('fr-FR');
}

async function markRead(id, actionUrl) {
    try {
        await fetch(`/api/notifications/${id}/read`, { method: 'POST' });
        if (actionUrl) {
            window.location.href = actionUrl;
        } else {
            loadNotifications();
        }
    } catch (error) {
        console.error('Error marking notification read:', error);
    }
}

async function markAllRead() {
    try {
        await fetch('/api/notifications/read-all', { method: 'POST' });
        loadNotifications();
    } catch (error) {
        console.error('Error marking all notifications read:', error);
    }
}

document.addEventListener('DOMContentLoaded', loadNotifications);
</script>
{% endblock %}
