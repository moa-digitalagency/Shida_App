{% extends "base.html" %}

{% block title %}Shida - Profil{% endblock %}

{% block content %}
<div class="profile-container">
    <div class="profile-header">
        <a href="/settings" class="settings-btn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="3"></circle>
                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
            </svg>
        </a>
        <button class="edit-btn" onclick="showEditModal()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
            </svg>
        </button>
    </div>
    
    <div class="profile-avatar-container">
        <img src="https://via.placeholder.com/150" alt="Profile" class="profile-avatar-large" id="profileAvatar">
        <div class="verified-badge-large" id="verifiedBadge" style="display: none;">
            <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
        </div>
    </div>
    
    <div class="profile-user-name" id="profileName">Chargement...</div>
    
    <div class="profile-bio" id="profileBio"></div>
    
    <div class="dossier-section">
        <div class="dossier-title">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            Mon Dossier
        </div>
        <div class="dossier-items">
            <div class="dossier-item">
                <div class="dossier-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"></path>
                        <path d="M2 17l10 5 10-5"></path>
                        <path d="M2 12l10 5 10-5"></path>
                    </svg>
                </div>
                <div class="dossier-value" id="profileReligion">-</div>
                <div class="dossier-label">Religion</div>
            </div>
            <div class="dossier-item">
                <div class="dossier-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                        <circle cx="12" cy="10" r="3"></circle>
                    </svg>
                </div>
                <div class="dossier-value" id="profileLocation">-</div>
                <div class="dossier-label">Localisation</div>
            </div>
            <div class="dossier-item">
                <div class="dossier-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
                        <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
                    </svg>
                </div>
                <div class="dossier-value" id="profileProfession">-</div>
                <div class="dossier-label">Profession</div>
            </div>
        </div>
    </div>
    
    <div class="objectives-section">
        <div class="section-title">Objectifs relationnels</div>
        <div class="interest-tags" id="objectiveTags">
            <span class="interest-tag" data-obj="Amitie">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="9" cy="7" r="4"></circle>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
                Amitie
            </span>
            <span class="interest-tag" data-obj="Construction">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polygon points="12 2 2 7 12 12 22 7 12 2"></polygon>
                    <polyline points="2 17 12 22 22 17"></polyline>
                    <polyline points="2 12 12 17 22 12"></polyline>
                </svg>
                Construction
            </span>
            <span class="interest-tag" data-obj="Mariage">
                <svg viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path>
                </svg>
                Mariage
            </span>
        </div>
    </div>
    
    <a href="/negotiations" class="negotiations-link">
        <div class="negotiations-link-content">
            <div class="negotiations-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
            </div>
            <div class="negotiations-text">
                <span class="negotiations-title">Mes Conversations</span>
                <span class="negotiations-subtitle">Voir mes matchs et messages</span>
            </div>
        </div>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="negotiations-arrow">
            <polyline points="9 18 15 12 9 6"></polyline>
        </svg>
    </a>
    
    <div class="ghost-mode-toggle">
        <div class="ghost-info">
            <div class="ghost-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path>
                    <circle cx="12" cy="12" r="3"></circle>
                    <line x1="1" y1="1" x2="23" y2="23"></line>
                </svg>
            </div>
            <div class="ghost-text">
                <h4>Mode Fantome</h4>
                <p>Voir sans etre vu</p>
            </div>
        </div>
        <label class="toggle-switch">
            <input type="checkbox" id="ghostToggle" onchange="toggleGhostMode()">
            <span class="toggle-slider"></span>
        </label>
    </div>
    
    <button class="verification-btn" id="verificationBtn" onclick="showVerificationModal()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
        </svg>
        Verifier mon profil
    </button>
    
    <button onclick="ShidaApp.logout()" class="logout-btn">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
        Deconnexion
    </button>
</div>

<div class="modal-overlay" id="editModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Modifier mon profil</h3>
            <button class="modal-close" onclick="hideEditModal()">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <form id="editForm" class="modal-form">
            <div class="form-group">
                <label>Prenom</label>
                <input type="text" id="editName" class="form-input" placeholder="Votre prenom">
            </div>
            <div class="form-group">
                <label>Age</label>
                <input type="number" id="editAge" class="form-input" min="18" max="99">
            </div>
            <div class="form-group">
                <label>Bio</label>
                <textarea id="editBio" class="form-input" rows="3" placeholder="Parlez-nous de vous..."></textarea>
            </div>
            <div class="form-group">
                <label>Religion</label>
                <select id="editReligion" class="form-input">
                    <option value="">Selectionner</option>
                    <option value="Chretienne">Chretienne</option>
                    <option value="Catholique">Catholique</option>
                    <option value="Protestante">Protestante</option>
                    <option value="Musulmane">Musulmane</option>
                    <option value="Autre">Autre</option>
                </select>
            </div>
            <div class="form-group">
                <label>Localisation</label>
                <input type="text" id="editLocation" class="form-input" placeholder="Votre commune/ville">
            </div>
            <div class="form-group">
                <label>Profession</label>
                <input type="text" id="editProfession" class="form-input" placeholder="Votre profession">
            </div>
            <div class="form-group">
                <label>Objectif</label>
                <select id="editObjective" class="form-input">
                    <option value="Amitie">Amitie</option>
                    <option value="Construction">Construction</option>
                    <option value="Mariage">Mariage</option>
                    <option value="Mariage & Serieux">Mariage & Serieux</option>
                </select>
            </div>
            <button type="submit" class="submit-btn">Enregistrer</button>
        </form>
    </div>
</div>

{% include "components/bottom_nav.html" %}
{% endblock %}

{% block scripts %}
<script>
let currentProfile = null;

document.addEventListener('DOMContentLoaded', async () => {
    await ShidaApp.init();
    await loadProfile();
    setupEditForm();
});

async function loadProfile() {
    try {
        const response = await fetch('/api/profile');
        currentProfile = await response.json();
        renderProfile(currentProfile);
    } catch (error) {
        console.error('Failed to load profile:', error);
    }
}

function renderProfile(profile) {
    document.getElementById('profileAvatar').src = profile.photo_url || 'https://via.placeholder.com/150';
    document.getElementById('profileName').innerHTML = `${profile.name || 'User'}, ${profile.age || ''} ${profile.is_verified ? '<span class="verified-inline"><svg viewBox="0 0 24 24" fill="currentColor" width="20" height="20"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></span>' : ''}`;
    document.getElementById('profileBio').textContent = profile.bio || '';
    document.getElementById('profileReligion').textContent = profile.religion || 'Non specifie';
    document.getElementById('profileLocation').textContent = profile.location || 'Non specifie';
    document.getElementById('profileProfession').textContent = profile.profession || 'Non specifie';
    
    if (profile.is_verified) {
        document.getElementById('verifiedBadge').style.display = 'flex';
        document.getElementById('verificationBtn').innerHTML = `
            <svg viewBox="0 0 24 24" fill="currentColor" stroke="none">
                <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
            </svg>
            Profil verifie
        `;
        document.getElementById('verificationBtn').classList.add('verified');
    }
    
    document.querySelectorAll('.interest-tag').forEach(tag => {
        tag.classList.remove('active');
        if (tag.dataset.obj === profile.objective) {
            tag.classList.add('active');
        }
    });
    
    if (ShidaApp.currentUser) {
        document.getElementById('ghostToggle').checked = ShidaApp.currentUser.ghost_mode;
    }
}

async function toggleGhostMode() {
    try {
        const response = await fetch('/api/profile/ghost-mode', { method: 'POST' });
        const result = await response.json();
        if (!response.ok) {
            alert(result.error || 'Fonctionnalite VIP requise');
            document.getElementById('ghostToggle').checked = !document.getElementById('ghostToggle').checked;
        }
    } catch (error) {
        console.error('Failed to toggle ghost mode:', error);
    }
}

function showEditModal() {
    const modal = document.getElementById('editModal');
    modal.classList.add('active');
    
    if (currentProfile) {
        document.getElementById('editName').value = currentProfile.name || '';
        document.getElementById('editAge').value = currentProfile.age || '';
        document.getElementById('editBio').value = currentProfile.bio || '';
        document.getElementById('editReligion').value = currentProfile.religion || '';
        document.getElementById('editLocation').value = currentProfile.location || '';
        document.getElementById('editProfession').value = currentProfile.profession || '';
        document.getElementById('editObjective').value = currentProfile.objective || 'Amitie';
    }
}

function hideEditModal() {
    document.getElementById('editModal').classList.remove('active');
}

function setupEditForm() {
    document.getElementById('editForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const data = {
            name: document.getElementById('editName').value,
            age: parseInt(document.getElementById('editAge').value),
            bio: document.getElementById('editBio').value,
            religion: document.getElementById('editReligion').value,
            location: document.getElementById('editLocation').value,
            profession: document.getElementById('editProfession').value,
            objective: document.getElementById('editObjective').value
        };
        
        try {
            const response = await fetch('/api/profile', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            
            if (response.ok) {
                currentProfile = await response.json();
                renderProfile(currentProfile);
                hideEditModal();
            } else {
                const error = await response.json();
                alert(error.error || 'Erreur lors de la mise a jour');
            }
        } catch (error) {
            console.error('Failed to update profile:', error);
        }
    });
}

function showVerificationModal() {
    alert('Fonctionnalite de verification bientot disponible!');
}
</script>
{% endblock %}
